<html>
    <head>
        <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <!-- Instructs the mobile browser to scale the web page to take
        as up much of the screen as possible -->
        <!-- Thanks to: https://creative-coding.decontextualize.com/mobile/ -->
        <meta name="viewport" content="user-scalable=no,initial-scale=1,maximum-scale=1,minimum-scale=1,width=device-width">
        <script src="https://cdn.jsdelivr.net/npm/p5@1.2.0/lib/p5.js"></script>
        <link rel="stylesheet" href="../progress/styles.css">
    </head>
    <body class="is-paused has-glitch">        
        <main>
            <div id="main" class="progress_wrapper">
                <h2>Progress:</h2>
            </div>
            <div class="panel">
                <div class="panel_buttons"></div>
                <div class="panel_commands">
                    <ul>                                  
                    </ul>                

                </div>
            </div>
        </main>
        
        <script>

            const default_duration = 30; // frames
            // duration is in seconds
            var actions = [
                {
                    name: 'rug',
                    duration: default_duration, 
                    color: 'limegreen'
                },
                {
                    name: 'spin',
                    duration: default_duration, 
                    color: 'magenta'
                },
                {
                    name: 'destroy',
                    duration: default_duration, 
                    color: 'yellow'
                },
                {
                    name: 'tighten',
                    duration: default_duration, 
                    color: 'cyan'
                },
                {
                    name: 'appeal to power',
                    duration: default_duration,
                    color: 'orange'
                }
            ]

            let commands = [];
            let active_command = 0;
            let command_start;
            let paused = true;

            var panel = document.querySelector('.panel_buttons');
            for (var i = 0; i < actions.length; i++) {
                var button = document.createElement('button');
                button.innerHTML = actions[i].name + ' <small>(5 frames)</small>';
                button.setAttribute('data-action-name', actions[i].name);
                button.setAttribute('data-action-duration', actions[i].duration);
                button.setAttribute('data-action-color', actions[i].color);
                button.style.backgroundColor = actions[i].color;
                panel.appendChild(button);
            }
            var buttons = document.querySelectorAll('button');
            var command_elem = document.querySelector('.panel_commands ul');
            buttons.forEach(function(button){
                button.addEventListener('click', function(){

                    setTimeout(function(){
                        const name = button.getAttribute('data-action-name');
                        const duration = button.getAttribute('data-action-duration');
                        const color = button.getAttribute('data-action-color');
                        commands.push(name);                    
                        update_commands({ 
                            name,
                            duration,
                            color
                        });          
                        // lose focus
                        button.blur();          
                        if (!command_start) command_start = Date.now() + 500
                    }, 250);                 
                })
            })

            const update_commands = ({ name, duration, color}) => {                                
                var li = document.createElement('li');
                var li_progress = document.createElement('span');                
                li_progress.classList.add('progress')
                li_progress.style.backgroundColor = color; 
                li.style.color = color;
                            
                li.innerText = name;
                command_elem.appendChild(li);
                li.appendChild(li_progress);
                li.setAttribute('data-action-duration', duration);
                
                set_featured();
            }

            let active = true;
            let state_duration;

            

            function set_featured(){
                const curr_commands = document.querySelectorAll('.panel_commands ul li');
                if (curr_commands){
                    for (var i = 0; i < 2; i++) {
                        const li_class = 'primary';
                        if (curr_commands[active_command + i]) curr_commands[active_command + i].classList.add(li_class);
                    }                    
                    
                }
            }

            function reset_commands(){
                active_command = 0;
                commands = [];
                command_elem.innerHTML = '';
                command_elem.style.top = 0;
            }
            function move_up(distance){
                // animate the list offscreen
                const start = Date.now();
                const duration = 100; // 2 seconds
                //const distance = -100;
                const command_elem_parent = command_elem.parentElement;

                const current_pos = command_elem.offsetTop - command_elem_parent.offsetTop;

                function move_list() {
                    
                    const elapsed = Date.now() - start;
                    const movement = (distance / duration * elapsed);
                    
                    let new_pos = current_pos + movement; // calculate new position
                                                  
                    if (Math.abs(movement) >= Math.abs(distance)) {
                        new_pos = current_pos + distance;
                        clearInterval(interval_id);
                        active = true;
                        command_elem.style.top = new_pos + 'px';
                        set_featured()
                        return;
                    }
                    command_elem.style.top = new_pos + 'px';
                    const curr_commands = document.querySelectorAll('.panel_commands ul li');
                    

                }

                const interval_id = setInterval(move_list, 10); // update position every 10 milliseconds

            }
            
            
            function loop(){                             
                const curr_commands = document.querySelectorAll('.panel_commands ul li');
                if (curr_commands){
                    const active_command_elem = curr_commands[active_command];

                    if (active_command_elem){                        
                        const progress = active_command_elem.querySelector('.progress');
                        if (progress){
                            const duration = parseFloat(active_command_elem.getAttribute('data-action-duration') * 1000);
                                                        
                            const progress_width = (Date.now() - command_start )/ duration * 100;                                                    
                            if (progress_width >= 100){    
                                // done
                                
                                const elem = active_command_elem;
                                // console.log(elem);
                                // console.log(elem.offsetHeight);
                                const total_height = elem.offsetHeight;
                                active = false;                        
                                move_up(- 1 * total_height);
                                command_start = Date.now();
                                active_command++;                                
                                
                            } else {                
                                progress.style.width = progress_width + '%';
                            
                            }
                    
                        }
                    }
                    if (active){                        
                        // reset list
                        if (active_command >= commands.length){
                            command_start = false;
                            const last_command = commands[commands.length - 1];
                            reset_commands();
                            if (last_command){
                                const last_command_trigger = document.querySelector('[data-action-name="' + last_command + '"]');
                                if (last_command_trigger) last_command_trigger.click();
                            }
                            
                        }
                    }                    
                }  
            
                // console.log(paused);
                // console.log(Date.now());
                                     
                if (!paused) requestAnimationFrame(loop);
            }
            // keypress on space key
            document.addEventListener('keypress', function(e){
                if (e.keyCode == 32){                    
                    paused = !paused;
                    if (!paused) requestAnimationFrame(loop);
                    command_start = Date.now();              
                }
            })

        </script>
        <style>
            canvas{
                display: none;
            }
            /* h2{
                margin: 0;                

            } */
            #main canvas{
                display: block;
                max-height: calc(10vh - 20px - 30px);
            }
            *{
                box-sizing: border-box;
            }
           

                body.is-glitching canvas{
                    position: fixed;
                    top: 0;
                    left: 0;
                    max-height: none !important;
                    border-radius: 0;
                    border: none;
                    width: 100% !important;
                    height: 100% !important;
                    z-index: 2;
                }
                body.is-glitching .progress_wrapper{
                    padding: 0;
                }
                body.is-finished:before{
                    font-family: 'Times New Roman', Times, serif;
                    content: 'DISCONNECTED';
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: #000;
                    color: white;
                    font-size: 10vh;
                    z-index: 3;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }

            main{
                height: 100vh;
                /* display: flex;
                flex-direction: column-reverse; */
                
            }

            canvas{
                height: 10vh;
                border-bottom: 1px solid white;
            }
                
            
            
            .panel{                
                width: 100%;
                
            }
            .panel_commands{                
                height: 90vh;
                overflow: scroll;
                background-color: black;
                color: white;                            
                                             
            }
            @media screen and (min-width: 600px){
                .panel{
                    display: flex;
                }
                .panel_commands{
                    width: 60vw;
                }
                .panel_buttons{
                    width: 40vw;
                    display: grid;                            
                }
            }
                

                
                .panel_commands .primary{
                    font-size: 10vh;                                
                }
                .panel_commands ul{
                    margin: 0;
                    padding: 0;
                    font-family: 'Times New Roman', Times, serif;
                    position: relative;
                    list-style: none;
                }
                .panel_commands li{
                    transition: 0.3s font-size;
                    margin: 0;
                    font-size: 3vh;   
                    position: relative;
                    padding: 10px 20px;
                    border-bottom: 1px solid white;
                }
                .progress{
                    position: absolute;
                    background-color: green;
                    height: 100%;
                    left: 0;
                    top: 0;
                    mix-blend-mode: difference;
                }
         

            button{                
                border: 10px solid #999;    
                font-size: 8vh;
                padding: 10px;
                cursor: pointer;
                line-height: 0.8;                
                display: block;
                width: 100%;
                border-right-color: #666;
                border-bottom-color: #666;
                -webkit-appearance: none;
                color: black;
            }
                /* button:not(:last-child){
                    //border-bottom: 0;
                } */
                button:active{
                    border-color: #666;
                    border-right-color: #999;
                    border-bottom-color: #999;
                }
                button small{
                    opacity: 0.5;
                    margin-top: 15px;
                    white-space: nowrap;
                    font-size: 0.4em;
                    display: block;
                }
                @media screen and (min-width: 600px) and (orientation: portrait){
                    button{
                        font-size: 6vh;
                    }
                }
        </style>        
                
        <script src="../progress/sketch.js" defer></script>
    </body>
</html>